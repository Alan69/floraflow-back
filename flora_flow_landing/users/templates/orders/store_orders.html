{% extends 'base.html' %}
{% load static %}

{% block main %}
<section class="store-orders-section">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="orders-content">
                    <div class="orders-header">
                        <h2>Активные заказы</h2>
                        <p class="text-muted">Список доступных заказов для выполнения</p>
                    </div>

                    <div id="orders-list" class="orders-list">
                        {% include "orders/partials/orders_list.html" %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Create WebSocket connection using the appropriate protocol
        const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const socket = new WebSocket(
            protocol + window.location.host + '/ws/notifications/',
            [], // protocols
            {
                headers: {
                    'Authorization': 'Bearer ' + '{{ request.session.access_token }}'
                }
            }
        );

        socket.onopen = function(e) {
            console.log('WebSocket connection established');
        };

        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            
            if (data.event === 'new_order' || data.event === 'order_update') {
                // Refresh the orders list
                fetch('{% url "store_orders" %}')
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById('orders-list').innerHTML = html;
                    });
            }
        };

        socket.onclose = function(e) {
            console.error('WebSocket closed unexpectedly');
            // Try to reconnect after 5 seconds
            setTimeout(function() {
                console.log('Attempting to reconnect...');
                window.location.reload();
            }, 5000);
        };

        socket.onerror = function(error) {
            console.error('WebSocket error:', error);
        };
    });
</script>
{% endblock %} 